stages:
  - test

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  POSTGRES_DB: mydb
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  DB_HOST: postgres

image: python:3.11-slim

services:
  - name: postgres:9.6.16
    alias: postgres

cache:
  paths:
    - .cache/pip

before_script:
  - python -V
  - pip install --upgrade pip
  - pip install -r requirements.txt

test:
  stage: test
  script: |
    set -euo pipefail

    echo "Waiting for Postgres to be ready..."
    for i in $(seq 1 30); do
      if pg_isready -h "$DB_HOST" -U "$POSTGRES_USER" >/dev/null 2>&1; then
        echo "Postgres is up!"
        break
      else
        echo "Postgres not ready yet..."
        sleep 1
      fi
    done

    # Run tests
    pytest -q
  artifacts:
    when: always
    reports:
      junit: junit.xml
